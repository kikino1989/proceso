-snapshot functionality broke.
-fix state management again.